<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nueva Asistencia - Nombre de tu Página Web</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .form-group-container {
      display: flex;
      justify-content: space-between;
      gap: 5px;
      margin-bottom: 10px;
    }
    .form-group {
      margin-bottom: 0;
    }
    .form-group label {
      display: block;
      margin-bottom: 2px;
      font-weight: bold;
    }
    select {
      padding: 8px;
      border: 1px solid #D1D1D1;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }
    .student-entry {
      display: table-row;
    }
    .student-entry div,
    .student-entry input,
    .student-entry button {
      display: table-cell;
      padding: 10px;
      text-align: center;
    }
    .attendance-options {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container shadow">
    <h1>Nueva Asistencia</h1>
    <form id="attendanceForm">
      <div class="form-group-container">
        <div class="form-group">
          <label for="attendanceDate">Fecha:</label>
          <input type="date" id="attendanceDate" required>
        </div>
        <div class="form-group">
          <label for="subjectSelect">Asignatura:</label>
          <select id="subjectSelect" required></select>
        </div>
      </div>
      <div style="display: table; width: 100%;">
        <div style="display: table-header-group; background-color: #F5F5F5;">
          <div class="student-entry">
            <div>Nombre del Estudiante</div>
            <div>P</div>
            <div>A</div>
            <div>J</div>
            <div>Acciones</div>
          </div>
        </div>
        <div id="studentsContainer" style="display: table-row-group;"></div>
      </div>
      <button type="button" id="addStudentBtn">Agregar Estudiante</button>
      <button type="submit">Guardar Asistencia</button>
    </form>
    <button onclick="location.href='dashboard.html'">Regresar al Menú Principal</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA_x5k1sH6R-UhBjNBCezuon5vC10c1uks",
      authDomain: "base-de-datos-web-ffd19.firebaseapp.com",
      databaseURL: "https://base-de-datos-web-ffd19-default-rtdb.firebaseio.com",
      projectId: "base-de-datos-web-ffd19",
      storageBucket: "base-de-datos-web-ffd19.firebasestorage.app",
      messagingSenderId: "158026017847",
      appId: "1:158026017847:web:f796f0ed6cd0789d0863b2",
      measurementId: "G-0BEHQR0E1G"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const database = getDatabase();

    // Cargar asignaturas en el combobox
    const subjectSelect = document.getElementById('subjectSelect');
    onValue(ref(database, 'subjects/'), (snapshot) => {
      subjectSelect.innerHTML = '<option value="">Seleccione una asignatura</option>'; // Placeholder
      snapshot.forEach((childSnapshot) => {
        const subject = childSnapshot.val();
        const option = document.createElement('option');
        option.value = JSON.stringify(subject); // Convertir el objeto a string
        option.textContent = `${subject.name} - ${subject.career} - Año ${subject.year}`;
        subjectSelect.appendChild(option);
      });
    });

    document.getElementById('attendanceForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const date = document.getElementById('attendanceDate').value;
      const selectedSubject = JSON.parse(subjectSelect.value); // Convertir el string de vuelta a objeto
      const students = document.querySelectorAll('.student-entry');
      const attendanceData = [];

      students.forEach(student => {
        const studentNameInput = student.querySelector('input[type=text]');
        const attendanceInput = student.querySelector('input[type=radio]:checked');

        if (studentNameInput && attendanceInput) {
          const studentName = studentNameInput.value;
          const attendance = attendanceInput.value;

          attendanceData.push({
            date: date,
            subject: selectedSubject.name,
            career: selectedSubject.career,
            year: selectedSubject.year,
            studentName: studentName,
            attendance: attendance,
            timestamp: new Date().toISOString()
          });
        } else {
          console.error("Elemento no encontrado");
        }
      });

      attendanceData.forEach(data => {
        push(ref(database, 'attendances/'), data)
          .then(() => {
            console.log("Asistencia guardada correctamente.");
          })
          .catch((error) => {
            console.error("Error al guardar la asistencia:", error);
          });
      });
    });

    window.addStudent = function addStudent() {
      const container = document.getElementById('studentsContainer');
      const studentEntry = document.createElement('div');
      studentEntry.className = 'student-entry';

      const studentNameCell = document.createElement('div');
      const studentNameInput = document.createElement('input');
      studentNameInput.type = 'text';
      studentNameInput.placeholder = 'Nombre del Estudiante';
      studentNameInput.required = true;
      studentNameCell.appendChild(studentNameInput);

      const presentCell = document.createElement('div');
      const presentInput = document.createElement('input');
      presentInput.type = 'radio';
      presentInput.name = `attendance_${container.children.length}`;
      presentInput.value = 'P';
      presentInput.required = true;
      presentCell.appendChild(presentInput);

      const absentCell = document.createElement('div');
      const absentInput = document.createElement('input');
      absentInput.type = 'radio';
      absentInput.name = `attendance_${container.children.length}`;
      absentInput.value = 'A';
      absentCell.appendChild(absentInput);

      const justifiedCell = document.createElement('div');
      const justifiedInput = document.createElement('input');
      justifiedInput.type = 'radio';
      justifiedInput.name = `attendance_${container.children.length}`;
      justifiedInput.value = 'J';
      justifiedCell.appendChild(justifiedInput);

      const actionCell = document.createElement('div');
      const removeButton = document.createElement('button');
      removeButton.type = 'button';
      removeButton.innerText = 'Eliminar';
      removeButton.onclick = () => container.removeChild(studentEntry);
      actionCell.appendChild(removeButton);

      studentEntry.appendChild(studentNameCell);
      studentEntry.appendChild(presentCell);
      studentEntry.appendChild(absentCell);
      studentEntry.appendChild(justifiedCell);
      studentEntry.appendChild(actionCell);
      container.appendChild(studentEntry);
    };

    document.getElementById('addStudentBtn').addEventListener('click', addStudent);
  </script>
</body>
</html>
